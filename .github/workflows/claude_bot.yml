name: Claude Code Issue Bot (Max Plan)

on:
  # Issueにコメントが作成されたら起動
  issue_comment:
    types: [created]

# ワークフローがリポジトリのファイルを編集・プッシュする権限
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-code-run:
    runs-on: ubuntu-latest

    # コメントが「@claude」で始まる場合のみ実行
    if: startsWith(github.event.comment.body, '@claude')

    steps:
      # 1. リポジトリのコードをサーバーにダウンロード
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Botが後でpushできるようにするため
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Node.js環境をセットアップ (claude-code CLIに必要)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 安定版

      # 3. claude-code CLI をサーバーにインストール
      - name: Install claude-code CLI
        run: npm install -g @anthropic-ai/claude-code

      # 4. claude-code CLI を実行（★ここで認証トークンを使用）
      - name: Run claude-code
        env:
          # ステップ2で登録した合鍵（トークン）をここで渡す
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # "@claude " の部分を除去して、指示内容だけを抽出
          PROMPT=$(echo "${{ github.event.comment.body }}" | sed 's/^@claude //')
          # プロンプトを引数として渡し、確認をスキップして自動実行
          claude --print --dangerously-skip-permissions "$PROMPT"

      # 6. AIによる変更をコミット＆プッシュ
      - name: Commit and push changes
        run: |
          git config --global user.name "Claude Code Bot"
          git config --global user.email "bot@users.noreply.github.com"
          git add .

          # 変更がある場合のみコミット＆プッシュ
          if ! git diff-index --quiet HEAD; then
            git commit -m "AI edit based on issue comment #${{ github.event.issue.number }}"
            git push
          else
            echo "No changes to commit."
          fi
